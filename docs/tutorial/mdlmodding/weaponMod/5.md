# 导入进游戏

这一章节将介绍如何将我们制作好的武器和动画编译打包进游戏里。你可以在制作动画或或测试模型的时候就进行这一步，方便你直观地看到效果。

## 5.1 编辑QC文件

让我们先处理打包第一人称的武器模型，还记得我们之前反编译的`ptpov_r97.mdl`吗，我们将其反编译到了`decompile_ptpov`文件夹里。

我们打开`decompile_ptpov`文件夹，找到里面的`ptpov_r97.qc`文件，使用文件编辑器打开，我比较喜欢使用VSCode。对于其他武器反编译后也是类似的，找到以`.qc`结尾的文件就是了。

接下来我们要以这个qc文件为中心修改，编辑qc文件并添加和编辑相关的一些文件，最后使用`Crowbar`配合兼容的SDK编译回MDL文件。

### 5.1.1 修改编译限制，替换模型文件

首先在`$modelname`下面添加一行`$maxverts  9999999`，这是为了提高模型顶点数量限制，后面的数值只要比你所有模型加起来的顶点数高就行。


```qc{5}
// Created by Crowbar 0.74

$modelname "weapons/r97/ptpov_r97.mdl" 

$maxverts  9999999 // [!code focus] [!code ++]

//$fadedist -1

```

然后我们编辑`$bodygroup`的相关内容，替换里面的studio指向的文件为我们自己的武器模型文件，注意bodygroup的变量名不能改，但是studio的变量名可以改，例如以下这是我自己的修改。记得武器本体和瞄准镜模型要区分开来放到对应的bodygroup里。


```qc
$bodygroup "ptpov_r97"
{
    studio "v_r97.smd" // [!code --]
	studio "wpnBase.smd" // [!code ++]
}
$bodygroup "proscreen"
{
	blank
	studio "v_proscreen.smd" // [!code --]
	studio "v_proscreenN.smd" // [!code ++]
}
$bodygroup "sight_holo"
{
	blank
	studio "v_holo.smd" // [!code --]
	studio "reddot.smd" // [!code ++]
}
```

::: tip
记得把这些模型smd文件放在qc文件同目录下
:::

然后找到`$sectionframes`, 调大其动画的帧数限制，不小于你最长动画的帧数。如果没有`$sectionframes` 则自行添加即可。

```qc
$bonemerge "ja_l_propHand"
$bonemerge "ja_r_propHand"


$sectionframes 30 190 // [!code focus] [!code --]
$sectionframes 30 9999999 // [!code focus] [!code ++]


$poseparameter "sprintfrac" 0 1 loop 0
$poseparameter "velocity" 0 173 loop 0
$poseparameter "ads_blend" 0 1 loop 0
```

### 5.1.2 处理`$definebone`和`$bonemerge`

因为我们已经对模型骨架进行修改了，qc文件里原来定义的已经不适用了。我们需要重新定义骨架。Crowbar能够帮助我们完成这个工作。

在`decompile_ptpov`下新建个`bonemerge.qci`文件并打开

然后我们再用文本编辑器打开我们自己的模型smd文件，例如我这里的"wpnBase.smd"，找到类似以下部分

![1wpnBase](./img/5/1wpnBase.png)

复制到`bonemerge.qci`里面

然后使用VSCode打开`bonemerge.qci`，使用正则表达式匹配搜索，搜索`^\s*\d+\s*"(.+)"\s*-?\d+\s*$`，然后替换为`$bonemerge "$1"`

![bonemerge](./img/5/2replace.gif)

然后删掉或注释原本QC里的所有`$bonemerge`内容，然后添加`$include "bonemerge.qci"`

```qc

// $bonemerge "def_l_ankle" // [!code focus] [!code --]
// $bonemerge "def_l_ball" // [!code focus] [!code --]
// $bonemerge "def_l_kneeB" // [!code focus] [!code --]
// $bonemerge "def_r_thigh" // [!code focus] [!code --]
// $bonemerge "def_r_knee" // [!code focus] [!code --]
// $bonemerge "def_r_ankle" // [!code focus] [!code --]
// $bonemerge "def_r_ball" // [!code focus] [!code --]
// $bonemerge "def_r_kneeB" // [!code focus] [!code --]
// $bonemerge "ja_l_propHand" // [!code focus] [!code --]
// $bonemerge "ja_r_propHand" // [!code focus] [!code --]

$include "bonemerge.qci" // [!code focus] [!code ++]

```

现在我们来重新定义骨架


在`decompile_ptpov`下新建个`definebone.qc`文件，内容模板如下：
```qc
$maxverts  9999999
$modelname "definebone/tmp.mdl"
$model "definebone" "wpnBase.smd" // "wpnBase.smd" 替换为你自己的模型文件
$include "bonemerge.qci"
$sequence "tmpSeq" "wpnBase.smd" //"wpnBase.smd" 替换为你自己的模型文件
```